<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <link rel="stylesheet" type="text/css" href="StyleSheet.css" />
    <title>Facebook Data Retrieval</title>
</head>
<body>
    <div class="login-card">
        <h1>FACE CARD</h1>

        <div id="fb-root"></div>
        <script src="jquery-1.11.2.min.js"></script>
        <script src="//www.parsecdn.com/js/parse-1.6.5.min.js"></script>
        <script>
            Parse.initialize("qDhmrRCHGBWBI8lO1WcSvuN6wO0xthwIgDYHjurj", "wDM7S3LxiJNN0exZQAb8szTnzHiS3gaLmS1j3VKk");
        </script>
        <script>
            //loads and initializes the Facebook SDK for Javascript and initializes it
            window.fbAsyncInit = function () {
                FB.init({
                    appId: '476842662488191',
                    //this controls if the current user login status is retrieved after each page refresh or not. If set to false, then it needs to be checked using getLoginStatus()
                    status: true,
                    cookie: true,
                    //indicates whether markup of social plugins is parsed(and rendered) or not
                    xfbml: true,
                });

                FB.Event.subscribe('auth.authResponseChange', function (response) {
                    if (response.status == 'connected') {
                        alert("Successfully connected to Facebook");
                    } else if (response.status == 'not_authorized') {
                        alert("Login Failed");
                    } else {
                        alert("Unknown Error");
                    }
                });
            };

            (function (doc) {
                var js;
                var id = 'facebook-jssdk';
                var ref = doc.getElementsByTagName('script')[0];
                if (doc.getElementById(id)) {
                    return;
                }
                js = doc.createElement('script');
                js.id = id;
                js.async = true;
                js.src = "//connect.facebook.net/en_US/all.js";
                ref.parentNode.insertBefore(js, ref);
            }(document));
        </script>
        <input type="button" class="login login-submit" value="Login" onclick="Login(function test(value) {console.log(JSON.stringify(value))});" />
        <script>
            function Login(callback) {
                FB.login(function (response) {
                    if (response.authResponse) {
                        FB.api('/me', 'GET', { "fields": "first_name,last_name,name,email,age_range,bio" }, function (response) {

                            var ParseHandler = Parse.Object.extend("KentScan");
                            var dataHandler = new ParseHandler();

                            dataHandler.set("userID", response.id);
                            dataHandler.set("firstName", response.first_name);
                            dataHandler.set("lastName", response.last_name);
                            dataHandler.set("userName", response.name);
                            dataHandler.set("emailAddress", response.email);
                            dataHandler.set("age", response.age_range.min.toString());
                            dataHandler.set("userBio", response.bio);

                            dataHandler.save(null, {
                                success: function (dataHandler) {
                                    alert('The data was saved. Thank you!');
                                },
                                error: function (dataHandler, error) {
                                    alert('Failed to save the data with error code: ' + error.message);
                                }
                            });

                            jsonStuff = JSON.stringify(response);
                            personName = response.name;

                            //console.log(jsonStuff);
                            callback(response);

                            var output = [];
                            for (var property in response) {
                                //output += property + ':' + response[property] + '; ';
                                output.push(property);
                            }
                            //alert(output);
                        });
                        //FB.api('/me/feed', 'post', { message: 'Hello, world again!' });
                        //FB.api('/me', function (response) {
                        //    document.getElementById("displayName").innerHTML = response.name;
                        //    document.getElementById("userName").innerHTML = response.username;
                        //    document.getElementById("userID").innerHTML = response.id;
                        //    document.getElementById("userEmail").innerHTML = response.email;
                        //    FB.api('/me/picture?type=normal', function (response) {
                        //        document.getElementById("profileImage").setAttribute("src", response.data.url);
                        //    });
                        //});
                    } else {
                        alert("Login Failed!");
                    }
                }, {
                    scope: 'user_about_me,user_location,email,user_friends'
                });
            }
        </script>
        <input type="button" class="login login-submit" value="Log Out" onclick="Logout();" />
        <script>
            function Logout() {
                FB.logout(function () { document.location.reload(); });
            }
        </script>
        <input type="button" class="login login-submit" value="User Friends" onclick="getFriends();" />
        <div id="placeholder"></div>

        <script src="jquery-1.11.2.min.js"></script>
        <script>

            function getFriends() {
                FB.api(
                  '/me',
                  'GET',
                  { "fields": "friends{first_name,last_name,picture}" },
                  function (response) {
                      console.log(response);
                  }
                );
            }
        </script>
        <input type="button" class="login login-submit" value="Download" onclick="downloadFile();" />
        <script>
            function downloadFile() {
                var element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(jsonStuff));
                element.setAttribute('download', personName + ".txt");
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            }
        </script>
    </div>
</body>
</html>